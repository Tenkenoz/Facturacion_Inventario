<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emisión de Facturas Electrónicas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'dark-primary': '#1e293b',
            'dark-secondary': '#334155',
            'dark-accent': '#475569',
            'dark-text': '#e2e8f0'
          }
        }
      }
    }
  </script>
  <style>
    /* Estilos para modo oscuro */
    .dark body {
      background-color: #111827;
      color: #e5e7eb;
    }
    
    .dark .bg-white {
      background-color: #1f2937 !important;
    }
    
    .dark .bg-gray-100 {
      background-color: #1f2937;
    }
    
    .dark aside {
      background-color: #1f2937;
      border-right: 1px solid #374151;
    }
    
    .dark input,
    .dark select,
    .dark textarea {
      background-color: #374151;
      border-color: #4b5563;
      color: #f3f4f6;
    }
    
    .dark input::placeholder,
    .dark textarea::placeholder {
      color: #9ca3af;
    }
    
    .dark table {
      border-color: #4b5563;
    }
    
    .dark th,
    .dark td {
      border-color: #4b5563;
      background-color: #1f2937;
    }
    
    .dark thead {
      background-color: #111827 !important;
    }
    
    .dark .bg-yellow-100 {
      background-color: #453411;
      color: #fbbf24;
    }
    
    .dark .bg-gray-100 {
      background-color: #111827 !important;
      border-color: #374151;
    }
    
    .dark footer {
      background-color: #1f2937;
      border-top: 1px solid #374151;
    }
    
    .dark .hover\:bg-gray-200:hover {
      background-color: #374151 !important;
    }
    
    .dark .text-gray-500 {
      color: #9ca3af !important;
    }
    
    /* Botón de tema */
    .theme-switch {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .dark .theme-switch {
      background: rgba(31, 41, 55, 0.5);
    }
    
    .theme-icon {
      font-size: 1.2rem;
      color: #333;
      transition: all 0.3s ease;
    }
    
    .dark .theme-icon {
      color: #fbbf24;
    }
    
    .theme-switch:hover {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.3);
    }
    
    .dark .theme-switch:hover {
      background: rgba(31, 41, 55, 0.7);
    }
    
    .animate-pulse {
      animation: pulse 0.3s ease;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .product-card {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .urgent-alert {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .mobile-menu {
      display: none;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      
      .mobile-menu {
        display: flex;
      }
      
      .main-content {
        padding: 1rem;
        margin-left: 0;
      }
      
      .responsive-table {
        overflow-x: auto;
      }
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .role-badge {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 0.75rem;
    }
    
    .invoice-preview {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    /* Estilos móviles */
    .mobile-header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0.75rem;
    }
    
    .dark .mobile-header {
      background: #1f2937;
    }
    
    .scrollable-table {
      overflow-x: auto;
      width: 100%;
    }
    
    .scrollable-table table {
      min-width: 600px;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
    }
    
    .discount-input {
      width: 50px;
      padding: 5px;
    }
    
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }
    
    .action-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
    }
    
    .dark .action-buttons {
      background: #1f2937;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
    }
    
    .action-buttons button {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-weight: 500;
    }
    
    .mobile-menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .dark .mobile-menu-btn {
      background: rgba(31, 41, 55, 0.8);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col dark:bg-gray-900">

  <!-- Botón de cambio de tema -->
  <div class="theme-switch" id="themeToggle" aria-label="Cambiar tema">
    <i class="bi bi-moon theme-icon" id="themeIcon"></i>
  </div>

  <!-- Barra superior para móviles -->
  <div class="mobile-menu d-md-none bg-white shadow-sm p-3 flex justify-between items-center dark:bg-dark-secondary">
    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="text-lg font-bold mb-0">Facturación</h1>
    <div class="d-flex align-items-center">
      <div class="user-avatar me-2">MA</div>
      <button class="btn btn-sm btn-outline-danger" id="logoutButtonMobile">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- Menú móvil desplegable -->
  <div class="offcanvas offcanvas-start dark:bg-dark-secondary" tabindex="-1" id="mobileMenu">
    <div class="offcanvas-header dark:bg-dark-primary">
      <h5 class="offcanvas-title dark:text-dark-text">Menú Principal</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body dark:bg-dark-secondary">
      <nav class="flex flex-col space-y-2" aria-label="Menú móvil">
        <a href="index.html" class="text-left px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-dark-accent">Panel Principal</a>
        <a href="busquedaFactura.html" class="text-left px-2 py-1 rounded bg-gray-100 font-semibold dark:bg-dark-accent">Facturación</a>
        <a href="busquedaInventario.html" class="text-left px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-dark-accent">Inventario</a>
      </nav>
      <div class="mt-4 p-3 bg-blue-50 rounded dark:bg-blue-900 dark:bg-opacity-20">
        <h6 class="font-semibold dark:text-dark-text">Rol: <span class="badge bg-primary role-badge">Facturación</span></h6>
        <p class="text-sm text-gray-600 mb-0 dark:text-gray-400">Último acceso: Hoy, 09:45 AM</p>
      </div>
    </div>
  </div>

  <div class="flex flex-1 min-h-screen">
    <!-- Menú lateral -->
    <aside class="sidebar w-64 bg-white p-4 shadow flex flex-col justify-between hidden md:flex dark:bg-dark-primary">
      <div>
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-xl font-bold dark:text-dark-text">Inventario Facturación</h1>
          <div class="flex items-center">
            <div class="user-avatar mr-2">MA</div>
            <button class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 text-red-600" id="logoutButton">
              <a href="inicioSesion.html"><i class="bi bi-box-arrow-right"></i></a>
            </button>
          </div>
        </div>
        <nav class="flex flex-col space-y-2" aria-label="Menú principal">
          <a href="index.html" class="text-left px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-dark-accent">Panel Principal</a>
          <a href="busquedaFactura.html" class="text-left px-2 py-1 rounded bg-gray-100 font-semibold dark:bg-dark-accent">Facturación</a>
          <a href="busquedaInventario.html" class="text-left px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-dark-accent">Inventario</a>
        </nav>
      </div>
      <div class="mt-4 p-3 bg-blue-50 rounded dark:bg-blue-900 dark:bg-opacity-20">
        <h6 class="font-semibold dark:text-dark-text">Rol: <span class="badge bg-primary role-badge">Facturación</span></h6>
        <p class="text-sm text-gray-600 mb-0 dark:text-gray-400">Último acceso: Hoy, 09:45 AM</p>
      </div>
    </aside>

    <!-- Contenido principal -->
    <main class="main-content flex-1 p-4 md:p-6 space-y-6 overflow-auto dark:bg-gray-900">
      <!-- Encabezado -->
      <header class="bg-white p-4 shadow rounded-md flex flex-col md:flex-row justify-between items-start md:items-center gap-4 dark:bg-dark-primary">
        <div>
          <h2 class="text-2xl font-bold dark:text-dark-text">Emisión de Facturas Electrónicas</h2>
          <p class="text-sm text-gray-500 mt-1 dark:text-gray-400">Crear una nueva factura con control de inventario en tiempo real</p>
        </div>
        <div class="flex items-center space-x-2">
          <span id="currentDateTime" class="text-sm text-gray-500 dark:text-gray-400"></span>
          <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition text-sm" id="saveDraftBtn">
            <i class="bi bi-save me-1"></i> Guardar
          </button>
        </div>
      </header>

      <!-- Sección de información -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Cliente -->
        <div>
          <h3 class="font-semibold mb-2 dark:text-dark-text">Información del Cliente</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div>
              <label class="block text-sm mb-1 dark:text-gray-400">Nombre/Razón Social</label>
              <input type="text" placeholder="Nombre completo" class="border p-2 rounded w-full dark:bg-dark-secondary" id="clientName" />
            </div>
            <div>
              <label class="block text-sm mb-1 dark:text-gray-400">Identificación</label>
              <input type="text" placeholder="Cédula/RUC" id="clientId" class="border p-2 rounded w-full dark:bg-dark-secondary" />
              <p id="error-clientId" class="text-red-600 text-sm mt-1 hidden">❌ Cédula inválida (solo números, 8-10 dígitos).</p>
            </div>
            <div>
              <label class="block text-sm mb-1 dark:text-gray-400">Teléfono</label>
              <input type="text" placeholder="Teléfono" id="clientPhone" class="border p-2 rounded w-full dark:bg-dark-secondary" />
            </div>
            <div>
              <label class="block text-sm mb-1 dark:text-gray-400">Email</label>
              <input type="email" placeholder="correo@ejemplo.com" id="clientEmail" class="border p-2 rounded w-full dark:bg-dark-secondary" />
            </div>
            <div>
              <label class="block text-sm mb-1 dark:text-gray-400">Fecha Emisión</label>
              <input type="date" class="border p-2 rounded w-full dark:bg-dark-secondary" id="emissionDate" />
            </div>
            <div>
              <label class="block text-sm mb-1 dark:text-gray-400">No. Factura</label>
              <input type="text" placeholder="Generando..." class="border p-2 rounded w-full dark:bg-dark-secondary bg-gray-100" id="invoiceNumber" readonly />
            </div>
          </div>
        </div>

        <!-- Detalles -->
        <div>
          <h3 class="font-semibold mb-2 dark:text-dark-text">Detalles de Factura</h3>
          <div class="mb-3">
            <label class="block text-sm mb-1 dark:text-gray-400">Forma de Pago</label>
            <select class="border p-2 rounded w-full dark:bg-dark-secondary" id="paymentMethod">
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta Crédito">Tarjeta Crédito</option>
              <option value="Tarjeta Débito">Tarjeta Débito</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Cheque">Cheque</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1 dark:text-gray-400">Observaciones</label>
            <textarea placeholder="Detalles adicionales..." class="border p-2 rounded w-full h-24 dark:bg-dark-secondary" id="notes"></textarea>
          </div>
        </div>
      </div>

      <!-- Buscador de productos -->
      <div class="mb-6">
        <h3 class="font-semibold mb-2 dark:text-dark-text">Agregar Productos</h3>
        <div class="flex items-center mb-4">
          <div class="relative flex-grow">
            <input type="text" placeholder="Buscar producto por nombre, código o categoría..." class="border p-2 rounded w-full mr-2 dark:bg-dark-secondary" id="productSearch" />
            <div id="searchResults" class="absolute z-10 w-full mt-1 bg-white dark:bg-dark-secondary shadow-lg rounded-md hidden"></div>
          </div>
          <button class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 transition flex items-center" id="addProductBtn">
            <i class="bi bi-plus-circle me-1"></i> Agregar
          </button>
        </div>
        
        <!-- Productos sugeridos -->
        <div class="product-grid" id="productGrid">
          <!-- Los productos se cargarán dinámicamente aquí -->
        </div>
      </div>

      <!-- Tabla de productos -->
      <div class="mb-6">
        <h3 class="font-semibold mb-2 dark:text-dark-text">Productos en Factura</h3>
        <div class="scrollable-table">
          <table class="w-full table-auto border mb-4 text-sm dark:border-gray-700" id="invoiceItemsTable">
            <thead class="bg-gray-100 dark:bg-dark-secondary">
              <tr>
                <th class="border px-2 py-1 dark:border-gray-700">Código</th>
                <th class="border px-2 py-1 dark:border-gray-700">Producto</th>
                <th class="border px-2 py-1 dark:border-gray-700">Stock</th>
                <th class="border px-2 py-1 dark:border-gray-700">Cantidad</th>
                <th class="border px-2 py-1 dark:border-gray-700">Precio Unit</th>
                <th class="border px-2 py-1 dark:border-gray-700">Descuento</th>
                <th class="border px-2 py-1 dark:border-gray-700">Subtotal</th>
                <th class="border px-2 py-1 dark:border-gray-700">Acciones</th>
              </tr>
            </thead>
            <tbody id="invoiceItemsBody">
              <!-- Los items se agregarán dinámicamente aquí -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Alerta de stock -->
      <div id="stockAlert" class="hidden bg-yellow-100 dark:bg-yellow-900 dark:bg-opacity-30 text-yellow-700 dark:text-yellow-300 p-3 rounded flex items-center text-sm mb-4">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span id="stockAlertText"></span>
      </div>

      <!-- Totales -->
      <div class="bg-gray-100 dark:bg-dark-secondary p-4 rounded w-full md:w-1/2 lg:w-1/3 ml-auto">
        <div class="flex justify-between mb-1">
          <span class="dark:text-gray-300">Subtotal:</span>
          <span class="font-medium" id="subtotalAmount">$0.00</span>
        </div>
        <div class="flex justify-between mb-1">
          <span class="dark:text-gray-300">Descuento:</span>
          <span class="text-red-600" id="discountAmount">-$0.00</span>
        </div>
        <div class="flex justify-between mb-1">
          <span class="dark:text-gray-300">IVA (12%):</span>
          <span class="font-medium" id="taxAmount">$0.00</span>
        </div>
        <div class="flex justify-between font-bold text-lg mt-3 pt-3 border-t dark:border-gray-700">
          <span class="dark:text-gray-300">Total:</span>
          <span class="text-blue-600" id="totalAmount">$0.00</span>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="flex justify-end mt-6 space-x-3">
        <button class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded transition dark:bg-gray-600 dark:hover:bg-gray-700 dark:text-white" id="cancelBtn">
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </button>

        <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition" id="issueBtn">
          <i class="bi bi-receipt me-1"></i> Emitir Factura
        </button>
      </div>
    </main>
  </div>

  <!-- Footer -->
  <footer class="bg-white text-center py-3 text-sm text-gray-500 mt-auto shadow-t dark:bg-dark-primary dark:text-gray-400">
    © 2025 Sistema de Inventario y Facturación. Cumple con normativas tributarias Ecuador. 
    <a href="#" class="text-blue-500 dark:text-blue-400">Política de Privacidad</a> | 
    <a href="#" class="text-blue-500 dark:text-blue-400">Términos de Uso</a> | 
    <a href="#" class="text-blue-500 dark:text-blue-400">Ayuda</a>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Axios para peticiones HTTP -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  // URL base de tu API Flask
  const API_BASE_URL = 'http://localhost:5000'; // Cambia esto por tu URL de producción
  
  // Variables globales
  let currentClient = null;
  let currentInvoice = {
    items: [],
    subtotal: 0,
    discount: 0,
    tax: 0,
    total: 0,
    paymentStatus: 'pending',
    status: 'draft'
  };
  let allProducts = [];

  // Control de tema oscuro/claro
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const htmlElement = document.documentElement;
  
  // Comprobar si hay preferencia guardada
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    enableDarkMode();
  }
  
  // Manejar el clic en el botón de tema
  themeToggle.addEventListener('click', () => {
    if (htmlElement.classList.contains('dark')) {
      disableDarkMode();
    } else {
      enableDarkMode();
    }
  });
  
  function enableDarkMode() {
    htmlElement.classList.add('dark');
    themeIcon.classList.remove('bi-moon');
    themeIcon.classList.add('bi-sun');
    localStorage.setItem('theme', 'dark');
  }
  
  function disableDarkMode() {
    htmlElement.classList.remove('dark');
    themeIcon.classList.remove('bi-sun');
    themeIcon.classList.add('bi-moon');
    localStorage.setItem('theme', 'light');
  }
  
  // Animación al cambiar el tema
  themeToggle.addEventListener('click', function() {
    this.classList.add('animate-pulse');
    setTimeout(() => {
      this.classList.remove('animate-pulse');
    }, 300);
  });

  // Función para formatear números como dinero
  function formatMoney(amount) {
    return new Intl.NumberFormat('es-EC', {
      style: 'currency',
      currency: 'USD'
    }).format(amount);
  }

  // Función para formatear fechas
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('es-EC', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Función para buscar clientes por identificación
  async function searchClient(identification) {
    try {
      const response = await axios.get(`${API_BASE_URL}/clientes/buscar?identificationNumber=${identification}`);
      
      if (response.data.length > 0) {
        currentClient = response.data[0];
        fillClientData(currentClient);
        return true;
      }
      return false;
      
    } catch (error) {
      console.error('Error al buscar cliente:', error);
      showAlert('Error al buscar cliente', 'error');
      return false;
    }
  }

  // Función para llenar datos del cliente
  function fillClientData(client) {
    document.getElementById('clientName').value = client.name;
    document.getElementById('clientPhone').value = client.phone || '';
    document.getElementById('clientEmail').value = client.email || '';
  }

  // Función para cargar productos desde la API
  async function loadProducts() {
    try {
      const response = await axios.get(`${API_BASE_URL}/productos`);
      
      allProducts = response.data;
      renderProductCards(allProducts);
      
    } catch (error) {
      console.error('Error al cargar productos:', error);
      showAlert('Error al cargar productos', 'error');
    }
  }

  // Función para renderizar tarjetas de productos
  function renderProductCards(products) {
    const productGrid = document.getElementById('productGrid');
    productGrid.innerHTML = '';
    
    // Ordenar productos por stock (los que tienen menos stock primero)
    const sortedProducts = [...products].sort((a, b) => a.stock - b.stock);
    
    sortedProducts.slice(0, 4).forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card bg-white dark:bg-dark-secondary p-3 rounded shadow cursor-pointer';
      card.setAttribute('data-id', product._id);
      card.setAttribute('data-name', product.name);
      card.setAttribute('data-price', product.price);
      card.setAttribute('data-stock', product.stock);
      card.setAttribute('data-code', product.code);
      
      card.innerHTML = `
        <div class="font-semibold dark:text-dark-text">${product.name}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">SKU: ${product.code}</div>
        <div class="text-sm mt-1">Stock: <span class="font-semibold">${product.stock}</span></div>
        <div class="font-semibold text-blue-600 mt-1">$${product.price.toFixed(2)}</div>
        ${product.stock < product.minStock ? '<div class="text-xs text-red-500 mt-1">Stock bajo</div>' : ''}
      `;
      
      card.addEventListener('click', () => addProductToInvoice(product));
      productGrid.appendChild(card);
    });
  }

  // Función para buscar productos
  async function searchProducts(query) {
    try {
      const response = await axios.get(`${API_BASE_URL}/productos/buscar?q=${query}`);
      showSearchResults(response.data);
      
    } catch (error) {
      console.error('Error al buscar productos:', error);
    }
  }

  // Función para mostrar resultados de búsqueda
  function showSearchResults(products) {
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '';
    
    if (products.length === 0) {
      resultsContainer.innerHTML = '<div class="p-2 text-gray-500">No se encontraron productos</div>';
      resultsContainer.classList.remove('hidden');
      return;
    }
    
    products.forEach(product => {
      const item = document.createElement('div');
      item.className = 'p-2 hover:bg-gray-100 dark:hover:bg-dark-accent cursor-pointer';
      item.innerHTML = `
        <div class="font-medium dark:text-dark-text">${product.name}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">${product.code} - Stock: ${product.stock} - $${product.price.toFixed(2)}</div>
      `;
      
      item.addEventListener('click', () => {
        addProductToInvoice(product);
        resultsContainer.classList.add('hidden');
        document.getElementById('productSearch').value = '';
      });
      
      resultsContainer.appendChild(item);
    });
    
    resultsContainer.classList.remove('hidden');
  }

  // Función para agregar producto a la factura
  function addProductToInvoice(product) {
    // Verificar si el producto ya está en la factura
    const existingItem = currentInvoice.items.find(item => item.product === product._id);
    
    if (existingItem) {
      // Incrementar cantidad si no supera el stock
      if (existingItem.quantity < product.stock) {
        existingItem.quantity += 1;
        existingItem.subtotal = existingItem.quantity * existingItem.unitPrice * (1 - existingItem.discount/100);
      } else {
        showAlert(`No hay suficiente stock de ${product.name}. Stock disponible: ${product.stock}`, 'warning');
        return;
      }
    } else {
      // Agregar nuevo item
      currentInvoice.items.push({
        product: product._id,
        name: product.name,
        code: product.code,
        quantity: 1,
        unitPrice: product.price,
        discount: 0,
        subtotal: product.price,
        stock: product.stock,
        minStock: product.minStock
      });
    }
    
    renderInvoiceItems();
    calculateTotals();
    checkStockAlerts();
  }

  // Función para renderizar items en la tabla
  function renderInvoiceItems() {
    const tbody = document.getElementById('invoiceItemsBody');
    tbody.innerHTML = '';
    
    currentInvoice.items.forEach((item, index) => {
      const row = document.createElement('tr');
      row.className = 'text-center';
      row.innerHTML = `
        <td class="border px-2 py-1 dark:border-gray-700">${item.code}</td>
        <td class="border px-2 py-1 dark:border-gray-700 text-left">${item.name}</td>
        <td class="border px-2 py-1 dark:border-gray-700">${item.stock} unid</td>
        <td class="border px-2 py-1 dark:border-gray-700">
          <input type="number" min="1" max="${item.stock}" value="${item.quantity}" 
                 class="w-16 text-center border rounded py-1 quantity-input" 
                 data-index="${index}" data-stock="${item.stock}">
        </td>
        <td class="border px-2 py-1 dark:border-gray-700">$${item.unitPrice.toFixed(2)}</td>
        <td class="border px-2 py-1 dark:border-gray-700">
          <input type="number" min="0" max="100" value="${item.discount}" 
                 class="w-16 text-center border rounded py-1 discount-input" 
                 data-index="${index}">
        </td>
        <td class="border px-2 py-1 dark:border-gray-700">$${item.subtotal.toFixed(2)}</td>
        <td class="border px-2 py-1 dark:border-gray-700">
          <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 remove-item-btn">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
    
    // Asignar eventos a los nuevos inputs
    document.querySelectorAll('.quantity-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const index = e.target.getAttribute('data-index');
        const newQuantity = parseInt(e.target.value);
        const maxStock = parseInt(e.target.getAttribute('data-stock'));
        
        if (newQuantity > maxStock) {
          showAlert(`No hay suficiente stock. Máximo disponible: ${maxStock}`, 'warning');
          e.target.value = maxStock;
          return;
        }
        
        if (newQuantity < 1) {
          e.target.value = 1;
          return;
        }
        
        currentInvoice.items[index].quantity = newQuantity;
        updateItemSubtotal(index);
      });
    });
    
    document.querySelectorAll('.discount-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const index = e.target.getAttribute('data-index');
        const discountValue = parseFloat(e.target.value);
        
        if (discountValue < 0) {
          e.target.value = 0;
          currentInvoice.items[index].discount = 0;
        } else if (discountValue > 100) {
          e.target.value = 100;
          currentInvoice.items[index].discount = 100;
        } else {
          currentInvoice.items[index].discount = discountValue;
        }
        
        updateItemSubtotal(index);
      });
    });
    
    document.querySelectorAll('.remove-item-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const index = e.target.closest('tr').querySelector('.quantity-input').getAttribute('data-index');
        currentInvoice.items.splice(index, 1);
        renderInvoiceItems();
        calculateTotals();
        checkStockAlerts();
      });
    });
  }

  // Función para actualizar subtotal de un item
  function updateItemSubtotal(index) {
    const item = currentInvoice.items[index];
    item.subtotal = item.quantity * item.unitPrice * (1 - item.discount/100);
    renderInvoiceItems();
    calculateTotals();
    checkStockAlerts();
  }

  // Función para calcular totales
  function calculateTotals() {
    currentInvoice.subtotal = currentInvoice.items.reduce((sum, item) => sum + item.subtotal, 0);
    
    // Calcular descuento total
    const totalWithoutDiscount = currentInvoice.items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
    currentInvoice.discount = totalWithoutDiscount - currentInvoice.subtotal;
    
    currentInvoice.tax = currentInvoice.subtotal * 0.12; // IVA 12%
    currentInvoice.total = currentInvoice.subtotal + currentInvoice.tax;
    
    // Actualizar UI
    document.getElementById('subtotalAmount').textContent = formatMoney(currentInvoice.subtotal);
    document.getElementById('discountAmount').textContent = formatMoney(currentInvoice.discount);
    document.getElementById('taxAmount').textContent = formatMoney(currentInvoice.tax);
    document.getElementById('totalAmount').textContent = formatMoney(currentInvoice.total);
  }

  // Función para verificar alertas de stock
  function checkStockAlerts() {
    const stockAlert = document.getElementById('stockAlert');
    const stockAlertText = document.getElementById('stockAlertText');
    
    // Buscar productos con stock crítico (menos del 30% del stock mínimo)
    const criticalItems = currentInvoice.items.filter(item => {
      const remainingStock = item.stock - item.quantity;
      return remainingStock < (item.minStock * 0.3);
    });
    
    if (criticalItems.length > 0) {
      stockAlertText.textContent = `${criticalItems[0].name}: Stock crítico después de esta venta (${criticalItems[0].stock - criticalItems[0].quantity} unidades)`;
      stockAlert.classList.remove('hidden');
      stockAlert.classList.add('urgent-alert');
    } else {
      stockAlert.classList.add('hidden');
    }
  }

  // Función para guardar borrador
  async function saveDraft() {
    if (!validateForm()) return;
    
    try {
      const invoiceData = prepareInvoiceData();
      invoiceData.status = 'draft';
      
      const response = await axios.post(`${API_BASE_URL}/facturas`, invoiceData);
      
      showAlert('Borrador guardado con éxito', 'success');
      console.log('Borrador guardado:', response.data);
      
    } catch (error) {
      console.error('Error al guardar borrador:', error);
      showAlert('Error al guardar borrador: ' + error.message, 'error');
    }
  }

  // Función para emitir factura
async function issueInvoice() {
    if (!validateForm()) return;
    
    if (currentInvoice.items.length === 0) {
        showAlert('Debe agregar al menos un producto a la factura', 'warning');
        return;
    }
    
    try {
        const invoiceData = prepareInvoiceData();
        console.log("Datos a enviar:", JSON.stringify(invoiceData, null, 2)); // <-- Añade esta línea
        invoiceData.status = 'issued';
        invoiceData.paymentStatus = document.getElementById('paymentMethod').value === 'Efectivo' ? 'paid' : 'pending';
        
        const response = await axios.post(`${API_BASE_URL}/facturas`, invoiceData);
        
        showAlert(`Factura ${response.data.invoiceNumber} emitida con éxito`, 'success');
        resetForm();
        
    } catch (error) {
        console.error('Detalles del error:', error.response?.data); // <-- Muestra más detalles del error
        showAlert(`Error al emitir factura: ${error.response?.data?.error || error.message}`, 'error');
    }
}
  // Función para preparar datos de la factura
  function prepareInvoiceData() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const notes = document.getElementById('notes').value;
    const issueDate = document.getElementById('emissionDate').value;
    
    // Validar fecha de emisión
    if (!issueDate) {
        throw new Error('La fecha de emisión es requerida');
    }
    
    // Preparar datos del cliente
    let clientData;
    if (currentClient && currentClient._id) {
        // Cliente existente
        clientData = currentClient._id;
    } else {
        // Nuevo cliente - validar datos mínimos
        const clientName = document.getElementById('clientName').value;
        const clientId = document.getElementById('clientId').value;
        
        if (!clientName || !clientId) {
            throw new Error('Datos del cliente incompletos');
        }
        
        clientData = {
            name: clientName,
            identificationType: clientId.length === 10 ? 'cedula' : 'ruc',
            identificationNumber: clientId,
            phone: document.getElementById('clientPhone').value || '',
            email: document.getElementById('clientEmail').value || '',
            status: 'active'
        };
    }
    
    // Preparar items
    const items = currentInvoice.items.map(item => ({
        product: item.product,
        quantity: item.quantity,
        unitPrice: item.unitPrice,
        discount: item.discount
    }));
    
    return {
        client: clientData,
        issueDate: issueDate,
        paymentMethod: paymentMethod,
        items: items,
        subtotal: currentInvoice.subtotal,
        tax: currentInvoice.tax,
        total: currentInvoice.total,
        notes: notes
    };
}
  // Función para validar el formulario
  function validateForm() {
    const clientName = document.getElementById('clientName').value;
    const clientId = document.getElementById('clientId').value;
    const errorClientId = document.getElementById('error-clientId');
    
    // Validar nombre del cliente
    if (!clientName || clientName.trim().length < 3) {
      showAlert('Debe ingresar un nombre válido para el cliente', 'warning');
      return false;
    }
    
    // Validar identificación del cliente
    if (!clientId || !/^\d{8,10}$/.test(clientId)) {
      errorClientId.classList.remove('hidden');
      return false;
    }
    errorClientId.classList.add('hidden');
    
    return true;
  }

  // Función para resetear el formulario
  function resetForm() {
    document.getElementById('clientName').value = '';
    document.getElementById('clientId').value = '';
    document.getElementById('clientPhone').value = '';
    document.getElementById('clientEmail').value = '';
    document.getElementById('notes').value = '';
    
    currentClient = null;
    currentInvoice = {
      items: [],
      subtotal: 0,
      discount: 0,
      tax: 0,
      total: 0,
      paymentStatus: 'pending',
      status: 'draft'
    };
    
    renderInvoiceItems();
    calculateTotals();
    document.getElementById('invoiceNumber').value = generateInvoiceNumber();
    document.getElementById('stockAlert').classList.add('hidden');
  }

  // Función para generar número de factura
  function generateInvoiceNumber() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    return `FAC-${year}${month}-${randomNum}`;
  }

  // Función para mostrar alertas
  function showAlert(message, type = 'info') {
    const alertTypes = {
      success: { icon: 'bi-check-circle', color: 'green' },
      error: { icon: 'bi-x-circle', color: 'red' },
      warning: { icon: 'bi-exclamation-triangle', color: 'yellow' },
      info: { icon: 'bi-info-circle', color: 'blue' }
    };
    
    const alertType = alertTypes[type] || alertTypes.info;
    
    // Crear toast de alerta
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded shadow-lg bg-${alertType.color}-100 dark:bg-${alertType.color}-900 dark:text-white flex items-start max-w-xs z-50`;
    toast.innerHTML = `
      <i class="bi ${alertType.icon} text-${alertType.color}-500 text-xl mr-2"></i>
      <div>${message}</div>
      <button class="ml-2 text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
        <i class="bi bi-x"></i>
      </button>
    `;
    
    // Botón para cerrar
    const closeBtn = toast.querySelector('button');
    closeBtn.addEventListener('click', () => {
      toast.remove();
    });
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
      toast.remove();
    }, 5000);
    
    document.body.appendChild(toast);
  }

  // Función para setear la fecha actual
  function setCurrentDate() {
    const today = new Date();
    document.getElementById('emissionDate').value = today.toISOString().split('T')[0];
  }

  // Función para actualizar el reloj
  function updateClock() {
    const now = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    document.getElementById('currentDateTime').textContent = now.toLocaleDateString('es-EC', options);
  }

  // Inicialización
  document.addEventListener('DOMContentLoaded', () => {
    // Configuración inicial
    document.getElementById('invoiceNumber').value = generateInvoiceNumber();
    setCurrentDate();
    updateClock();
    setInterval(updateClock, 1000);
    
    // Cargar productos
    loadProducts();
    
    // Buscar cliente al perder foco de la cédula
    document.getElementById('clientId').addEventListener('blur', async (e) => {
      const cedula = e.target.value.trim();
      if (cedula.length >= 8 && cedula.length <= 10 && /^\d+$/.test(cedula)) {
        const found = await searchClient(cedula);
        if (!found) {
          // Cliente no encontrado, permitir crear uno nuevo
          currentClient = {
            identificationNumber: cedula,
            name: '',
            phone: '',
            email: ''
          };
        }
      } else {
        document.getElementById('error-clientId').classList.remove('hidden');
      }
    });
    
    // Validar cédula al escribir
    document.getElementById('clientId').addEventListener('input', (e) => {
      if (/^\d{8,10}$/.test(e.target.value)) {
        document.getElementById('error-clientId').classList.add('hidden');
      }
    });
    
    // Buscar productos al escribir
    document.getElementById('productSearch').addEventListener('input', (e) => {
      if (e.target.value.length > 2) {
        searchProducts(e.target.value);
      } else {
        document.getElementById('searchResults').classList.add('hidden');
      }
    });
    
    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#productSearch') && !e.target.closest('#searchResults')) {
        document.getElementById('searchResults').classList.add('hidden');
      }
    });
    
    // Botones
    document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
    document.getElementById('issueBtn').addEventListener('click', issueInvoice);
    document.getElementById('cancelBtn').addEventListener('click', resetForm);
    
    // Botón de agregar producto manualmente
    document.getElementById('addProductBtn').addEventListener('click', () => {
      const searchInput = document.getElementById('productSearch');
      if (searchInput.value.length > 0) {
        searchProducts(searchInput.value);
      } else {
        showAlert('Ingrese un término de búsqueda para agregar productos', 'warning');
      }
    });
    
    // Logout
    document.getElementById('logoutButton').addEventListener('click', () => {
      localStorage.removeItem('authToken');
      window.location.href = 'inicioSesion.html';
    });
    
    document.getElementById('logoutButtonMobile').addEventListener('click', () => {
      localStorage.removeItem('authToken');
      window.location.href = 'inicioSesion.html';
    });
  });
</script>
</body>
</html>